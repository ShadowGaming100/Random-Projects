<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RouteMap Builder Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables for Light Mode */
        :root {
            --primary-color: #3a86ff;
            --primary-dark: #2667cc;
            --primary-light: #a6c8ff;
            --secondary-color: #8338ec;
            --accent-color: #ff006e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --medium-gray: #adb5bd;
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #ff9f1c;
            --info-color: #00bbf9;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --sidebar-width: 380px;
            --header-height: 70px;
            --canvas-bg: #f9fafc;
            --node-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --border-color: #dee2e6;
            --modal-bg: #ffffff;
            --selection-color: rgba(58, 134, 255, 0.2);
        }

        /* Dark Mode Variables */
        .dark-mode {
            --primary-color: #5a9cff;
            --primary-dark: #3a7cdf;
            --primary-light: #2d3748;
            --secondary-color: #9d4edd;
            --accent-color: #ff4d8d;
            --light-color: #121212;
            --dark-color: #e9ecef;
            --gray-color: #a0aec0;
            --light-gray: #2d3748;
            --medium-gray: #4a5568;
            --danger-color: #f56565;
            --success-color: #38b2ac;
            --warning-color: #ed8936;
            --info-color: #4299e1;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
            --canvas-bg: #1a202c;
            --node-bg: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
            --modal-bg: #2d3748;
            --selection-color: rgba(90, 156, 255, 0.3);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            transition: var(--transition);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* App Layout */
        .app-container {
            display: flex;
            height: 100vh;
            flex-direction: row;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--node-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .sidebar-header h1 i {
            font-size: 1.8rem;
        }

        .sidebar-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }

        /* Improved scrolling for mobile */
        .sidebar-content {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .section-title span {
            font-size: 0.8rem;
            font-weight: 400;
            opacity: 0.8;
            text-align: right;
            flex-shrink: 0;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            width: 100%;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Icon Input Styles */
        .icon-input-container {
            position: relative;
            width: 100%;
        }

        .icon-input {
            padding-left: 40px !important;
        }

        .icon-preview {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: var(--gray-color);
            pointer-events: none;
        }

        .icon-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .icon-picker-modal.active {
            display: flex;
        }

        .icon-picker-content {
            background-color: var(--modal-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .icon-picker-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .icon-picker-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .icon-search {
            margin-bottom: 20px;
        }

        .icon-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .icon-category-btn {
            padding: 8px 12px;
            background: var(--light-gray);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .icon-category-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .icon-item {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .icon-item:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .icon-item.selected {
            border-color: var(--primary-color);
            background: var(--selection-color);
        }

        .icon-item i {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .icon-name {
            font-size: 0.7rem;
            text-align: center;
            word-break: break-word;
            color: var(--text-secondary);
        }

        /* Button Styles */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: var(--medium-gray);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c1121f;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #21867a;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68a00;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #0ea5e9;
            transform: translateY(-2px);
        }

        .btn-full {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            width: 100%;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* Pages List */
        .pages-list {
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            width: 100%;
        }

        .page-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .page-item:hover {
            background-color: var(--light-gray);
        }

        .page-item.selected {
            background-color: var(--selection-color);
            border-left: 4px solid var(--primary-color);
        }

        .page-item.multi-selected {
            background-color: var(--selection-color);
            border-left: 4px solid var(--info-color);
        }

        .page-item:last-child {
            border-bottom: none;
        }

        .page-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex: 1;
        }

        .page-icon {
            font-size: 0.9rem;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .page-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .page-item:hover .page-actions {
            opacity: 1;
        }

        .page-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-color);
            font-size: 0.9rem;
            transition: var(--transition);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .page-action-btn:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }

        /* Selection Info Bar */
        .selection-info {
            padding: 12px 15px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--info-color);
            width: 100%;
        }

        .selection-info.hidden {
            display: none;
        }

        .selection-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* Mass Edit Form */
        .mass-edit-form {
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed var(--info-color);
            width: 100%;
        }

        .mass-edit-form.hidden {
            display: none;
        }

        /* Main Canvas Area */
        .main-canvas {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--canvas-bg);
            transition: var(--transition);
            min-width: 0;
        }

        .canvas-header {
            padding: 0 25px;
            background-color: var(--node-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            height: var(--header-height);
            transition: var(--transition);
            flex-wrap: wrap;
        }

        .canvas-title h2 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .canvas-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .canvas-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .canvas-area {
            width: 100%;
            height: calc(100% - var(--header-height));
            position: relative;
            overflow: auto;
            background-image:
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px),
                linear-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 40px 40px;
            background-color: var(--canvas-bg);
            -webkit-overflow-scrolling: touch;
        }

        /* Selection Box */
        .selection-box {
            position: absolute;
            border: 2px solid var(--primary-color);
            background-color: var(--selection-color);
            z-index: 20;
            pointer-events: none;
        }

        /* Page Nodes */
        .page-node {
            position: absolute;
            width: 200px;
            background-color: var(--node-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            cursor: move;
            transition: var(--transition);
            border: 2px solid transparent;
            z-index: 5;
            touch-action: none;
        }

        .page-node:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .page-node.selected {
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px rgba(58, 134, 255, 0.25);
        }

        .page-node.multi-selected {
            border-color: var(--info-color);
            box-shadow: 0 8px 20px rgba(0, 187, 249, 0.25);
        }

        .page-node.dynamic {
            border-left: 5px solid var(--accent-color);
        }

        .page-node.static {
            border-left: 5px solid var(--success-color);
        }

        .page-node-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 10px;
        }

        .page-node-title {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex: 1;
        }

        .page-node-title-icon {
            flex-shrink: 0;
            font-size: 1rem;
        }

        .page-node-title-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-node-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .page-node-home {
            background-color: rgba(58, 134, 255, 0.15);
            color: var(--primary-color);
        }

        .page-node-dynamic {
            background-color: rgba(255, 0, 110, 0.15);
            color: var(--accent-color);
        }

        .page-node-static {
            background-color: rgba(42, 157, 143, 0.15);
            color: var(--success-color);
        }

        .page-node-path {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: monospace;
            padding: 5px;
            background-color: var(--light-color);
            border-radius: 4px;
            width: 100%;
        }

        .page-node-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-color);
            margin-bottom: 5px;
            width: 100%;
        }

        .page-node-children {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--info-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Connection Lines */
        .connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .connection line {
            stroke: var(--primary-color);
            stroke-width: 3;
            marker-end: url(#arrowhead);
            opacity: 0.7;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-bg);
            width: 100%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .modal-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-footer {
            padding: 20px;
            background-color: var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Export/Import Options */
        .export-options,
        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .export-option-btn,
        .import-option-btn {
            flex-direction: column;
            height: 100px;
            padding: 20px;
            text-align: center;
            width: 100%;
        }

        .export-option-btn i,
        .import-option-btn i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .code-block {
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .code-block-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-block-title .btn-sm {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }

        .settings-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .settings-btn:hover {
            transform: rotate(30deg);
            background-color: var(--primary-dark);
        }

        .settings-menu {
            position: absolute;
            bottom: 60px;
            right: 0;
            background-color: var(--node-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 15px;
            width: 250px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .settings-menu.active {
            display: flex;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
            width: 100%;
        }

        .settings-item:hover {
            background-color: var(--light-gray);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-color);
            text-align: center;
            padding: 40px;
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: var(--light-gray);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            width: 100%;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transform: translateX(-20px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.active {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        /* File Input */
        .file-input-container {
            position: relative;
            margin-bottom: 20px;
            width: 100%;
        }

        .file-input-label {
            display: block;
            padding: 30px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .file-input-label:hover {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.05);
        }

        .file-input-label i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .file-input-label h4 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .file-input-label p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Mass Delete Confirmation */
        .mass-delete-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            width: 100%;
        }

        .mass-delete-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: var(--light-color);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* Responsive Design - MOBILE FIRST APPROACH */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 340px;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
                height: 100vh;
            }

            .sidebar {
                width: 100%;
                height: 45vh;
                max-height: 45vh;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
            }

            .main-canvas {
                height: 55vh;
                flex-shrink: 0;
            }

            .canvas-header {
                padding: 15px;
                height: auto;
                min-height: var(--header-height);
                flex-wrap: wrap;
            }

            .canvas-title {
                width: 100%;
                margin-bottom: 10px;
            }

            .canvas-actions {
                width: 100%;
                justify-content: center;
                gap: 5px;
            }

            .canvas-area {
                height: calc(100% - 90px);
            }

            .page-node {
                width: 180px;
                padding: 12px;
            }

            .export-options,
            .import-options {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                height: 50vh;
                max-height: 50vh;
            }

            .main-canvas {
                height: 50vh;
            }

            .canvas-actions .btn {
                padding: 8px 10px;
                font-size: 0.85rem;
                min-width: auto;
                flex: 1;
            }

            .export-options,
            .import-options {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-height: 90vh;
                margin: 0;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .icon-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                height: 55vh;
                max-height: 55vh;
            }

            .main-canvas {
                height: 45vh;
            }

            .sidebar-header {
                padding: 15px;
            }

            .sidebar-header h1 {
                font-size: 1.2rem;
            }

            .sidebar-content {
                padding: 15px;
            }

            .canvas-header {
                padding: 10px;
            }

            .canvas-title h2 {
                font-size: 1.1rem;
            }

            .canvas-subtitle {
                font-size: 0.8rem;
            }

            .page-node {
                width: 160px;
                padding: 10px;
            }

            .page-node-title {
                font-size: 1rem;
            }

            .page-node-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }

            .page-node-path {
                font-size: 0.75rem;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .settings-panel {
                bottom: 10px;
                right: 10px;
            }

            .settings-menu {
                width: 200px;
            }

            .notification {
                max-width: calc(100% - 40px);
                font-size: 0.9rem;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .page-actions {
                opacity: 1 !important;
            }

            .page-action-btn {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .btn {
                min-height: 44px; /* Apple recommended minimum touch target */
            }

            .page-node {
                touch-action: pan-x pan-y;
            }

            .selection-info {
                padding: 15px;
            }
        }

        /* Landscape orientation for mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            .sidebar {
                height: 65vh;
                max-height: 65vh;
            }

            .main-canvas {
                height: 35vh;
            }

            .pages-list {
                max-height: 150px;
            }

            .canvas-area {
                height: calc(100% - 70px);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-color);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-color);
            color: var(--light-color);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
            box-shadow: var(--shadow);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-color) transparent transparent transparent;
        }

        @media (hover: hover) {
            .tooltip:hover .tooltip-text {
                visibility: visible;
                opacity: 1;
            }
        }

        /* Keyboard Shortcut Hints */
        .keyboard-hint {
            font-size: 0.75rem;
            color: var(--gray-color);
            margin-top: 5px;
            display: block;
            line-height: 1.4;
        }

        .keyboard-hint kbd {
            background-color: var(--light-gray);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.7rem;
        }

        /* Mobile sidebar toggle button */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 900px) {
            .mobile-sidebar-toggle {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                z-index: 999;
                transition: left 0.3s ease;
                border-right: none;
            }

            .sidebar.active {
                left: 0;
            }

            .main-canvas {
                width: 100%;
                height: 100vh;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 998;
            }

            .overlay.active {
                display: block;
            }
        }

        /* Icon categories styling */
        .icon-categories {
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .icon-categories::-webkit-scrollbar {
            height: 4px;
        }

        /* Prevent text selection on mobile */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Fix for iOS input zoom */
        @media screen and (max-width: 768px) {
            input,
            select,
            textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }

        /* Safe area insets for modern mobile browsers */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .sidebar-header {
                padding-top: max(20px, env(safe-area-inset-top));
            }
        }
    </style>
</head>

<body class="no-select">
    <!-- Mobile Sidebar Toggle -->
    <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay"></div>

    <div class="app-container">
        <!-- Sidebar with page controls -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-project-diagram"></i> RouteMap Pro</h1>
                <button id="theme-toggle" class="btn btn-secondary btn-sm">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Selection Info Bar -->
                <div class="selection-info hidden" id="selection-info">
                    <div style="min-width: 0; flex: 1;">
                        <strong><span id="selected-count">0</span> page(s) selected</strong>
                        <div class="keyboard-hint">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="selection-actions">
                        <button id="deselect-all-btn" class="btn btn-sm btn-secondary" title="Deselect All">
                            <i class="fas fa-times"></i>
                        </button>
                        <button id="mass-delete-btn" class="btn btn-sm btn-danger" title="Delete Selected">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Mass Edit Form -->
                <div class="mass-edit-form hidden" id="mass-edit-form">
                    <h3 class="section-title">Edit Multiple Pages</h3>
                    <div class="form-group">
                        <label for="mass-parent-page">Set Parent For All</label>
                        <select id="mass-parent-page" class="form-control">
                            <option value="">Keep Current Parent</option>
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mass-page-type">Set Type For All</label>
                        <select id="mass-page-type" class="form-control">
                            <option value="">Keep Current Type</option>
                            <option value="static">Static Page</option>
                            <option value="dynamic">Dynamic Page</option>
                            <option value="api">API Route</option>
                            <option value="auth">Auth Protected</option>
                        </select>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <i class="fas fa-lock"></i>
                            <span>Set Protected Status</span>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label>
                                <input type="radio" name="mass-protected" value="" checked> Keep
                            </label>
                            <label>
                                <input type="radio" name="mass-protected" value="true"> Yes
                            </label>
                            <label>
                                <input type="radio" name="mass-protected" value="false"> No
                            </label>
                        </div>
                    </div>
                    <button id="apply-mass-edit-btn" class="btn btn-success btn-full">
                        <i class="fas fa-check"></i> Apply Changes to Selected
                    </button>
                </div>

                <!-- Single Page Edit Form -->
                <div id="single-edit-form">
                    <h3 class="section-title">Page Editor <span id="page-count">0 pages</span></h3>
                    
                    <div class="form-group">
                        <label for="page-icon-input">Icon (Font Awesome)</label>
                        <div class="icon-input-container">
                            <input type="text" id="page-icon-input" class="icon-input" placeholder="fas fa-home or custom text" value="fas fa-file">
                            <div class="icon-preview">
                                <i id="icon-preview" class="fas fa-file"></i>
                            </div>
                        </div>
                        <div class="keyboard-hint" style="margin-top: 5px;">
                            <button type="button" id="open-icon-picker" class="btn btn-sm btn-secondary" style="margin-top: 5px; width: auto;">
                                <i class="fas fa-icons"></i> Browse Icons
                            </button>
                            Enter Font Awesome class (e.g., "fas fa-home") or any text
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="page-name">Page Name</label>
                        <input type="text" id="page-name" placeholder="e.g., Home, About, Blog">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="page-type">Page Type</label>
                            <select id="page-type" class="form-control">
                                <option value="static">Static Page</option>
                                <option value="dynamic">Dynamic Page</option>
                                <option value="api">API Route</option>
                                <option value="auth">Auth Protected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="parent-page">Parent Page</label>
                            <select id="parent-page" class="form-control">
                                <option value="">None (Top Level)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="page-slug">URL Slug (Optional)</label>
                        <input type="text" id="page-slug" placeholder="Custom URL path">
                    </div>
                    
                    <div class="form-group">
                        <label for="page-description">Description</label>
                        <textarea id="page-description" placeholder="Page description..."></textarea>
                    </div>

                    <div class="toggle-container">
                        <div class="toggle-label">
                            <i class="fas fa-lock"></i>
                            <span>Protected Route</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="page-protected">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="page-actions">
                        <button id="add-page-btn" class="btn btn-primary btn-full">
                            <i class="fas fa-plus-circle"></i> Add Page
                        </button>
                        <button id="update-page-btn" class="btn btn-success btn-full" style="display: none;">
                            <i class="fas fa-save"></i> Update Page
                        </button>
                        <button id="cancel-edit-btn" class="btn btn-secondary btn-full" style="display: none;">
                            <i class="fas fa-times"></i> Cancel Edit
                        </button>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <h3 class="section-title">All Pages
                        <span class="keyboard-hint">
                            <kbd>Ctrl</kbd>+Click to multi-select â€¢ <kbd>Ctrl</kbd>+<kbd>A</kbd> to select all
                        </span>
                    </h3>
                    <ul id="pages-list" class="pages-list">
                        <!-- Pages will be added here dynamically -->
                    </ul>
                </div>

                <div class="quick-actions">
                    <button id="select-all-btn" class="btn btn-info btn-sm">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button id="duplicate-selected-btn" class="btn btn-warning btn-sm">
                        <i class="fas fa-copy"></i> Duplicate Selected
                    </button>
                    <button id="group-selected-btn" class="btn btn-success btn-sm">
                        <i class="fas fa-object-group"></i> Group Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Main canvas area -->
        <div class="main-canvas">
            <div class="canvas-header">
                <div class="canvas-title">
                    <h2>Website Structure Canvas</h2>
                    <div class="canvas-subtitle">
                        <span id="selection-info-canvas">No selection</span> â€¢
                        Drag to select multiple â€¢ Right-click for options
                    </div>
                </div>
                <div class="canvas-actions">
                    <button id="import-btn" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button id="export-btn" class="btn btn-primary">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button id="save-project-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button id="load-project-btn" class="btn btn-info">
                        <i class="fas fa-folder-open"></i> Load
                    </button>
                    <button id="reset-btn" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Clear
                    </button>
                </div>
            </div>
            <div class="canvas-area" id="canvas-area">
                <!-- Selection Box -->
                <div class="selection-box" id="selection-box" style="display: none;"></div>

                <!-- Connection lines layer -->
                <svg id="connections-layer"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary-color)" />
                        </marker>
                        <marker id="dashed-arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5"
                            orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)" />
                        </marker>
                    </defs>
                </svg>

                <!-- Page nodes will be added here dynamically -->

                <!-- Empty state -->
                <div class="empty-state" id="empty-state">
                    <i class="fas fa-sitemap"></i>
                    <h3>No Pages Added Yet</h3>
                    <p>Start building your website structure by adding pages from the sidebar.</p>
                    <div style="margin-top: 20px;">
                        <button id="create-sample-btn" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Create Sample Structure
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="settings-menu" id="settings-menu">
                <div class="settings-item">
                    <span><i class="fas fa-palette"></i> Canvas Grid</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-grid" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span><i class="fas fa-vector-square"></i> Auto Layout</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-layout">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span><i class="fas fa-mouse-pointer"></i> Multi-Select Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="multi-select-mode" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span><i class="fas fa-history"></i> Undo/Redo</span>
                    <div>
                        <button id="undo-btn" class="btn btn-sm btn-secondary" title="Undo">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button id="redo-btn" class="btn btn-sm btn-secondary" title="Redo">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>
            <button class="settings-btn" id="settings-btn">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div class="icon-picker-modal" id="icon-picker-modal">
        <div class="icon-picker-content">
            <div class="icon-picker-header">
                <h3>Select Icon</h3>
                <button class="close-modal" id="close-icon-picker">&times;</button>
            </div>
            <div class="icon-picker-body">
                <div class="icon-search">
                    <input type="text" id="icon-search-input" placeholder="Search icons..." class="form-control">
                </div>
                <div class="icon-categories" id="icon-categories">
                    <button class="icon-category-btn active" data-category="all">All</button>
                    <button class="icon-category-btn" data-category="common">Common</button>
                    <button class="icon-category-btn" data-category="navigation">Navigation</button>
                    <button class="icon-category-btn" data-category="content">Content</button>
                    <button class="icon-category-btn" data-category="social">Social</button>
                    <button class="icon-category-btn" data-category="custom">Custom</button>
                </div>
                <div class="icon-grid" id="icon-grid">
                    <!-- Icons will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Export/Import Modal -->
    <div class="modal" id="export-import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="export-import-modal-title">Export / Import Project</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options" id="export-section">
                    <button id="export-json-btn" class="btn btn-primary export-option-btn">
                        <i class="fas fa-file-code"></i>
                        <span>JSON Structure</span>
                    </button>
                    <button id="export-sitemap-btn" class="btn btn-secondary export-option-btn">
                        <i class="fas fa-sitemap"></i>
                        <span>Text Sitemap</span>
                    </button>
                    <button id="export-react-btn" class="btn btn-info export-option-btn">
                        <i class="fab fa-react"></i>
                        <span>React Routes</span>
                    </button>
                    <button id="export-nextjs-btn" class="btn btn-dark export-option-btn">
                        <i class="fas fa-file-alt"></i>
                        <span>Next.js Routes</span>
                    </button>
                </div>

                <div class="import-options" id="import-section">
                    <div class="file-input-container">
                        <label class="file-input-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Import Project File</h4>
                            <p>Drag & drop or click to upload a JSON file</p>
                            <input type="file" id="import-file" class="file-input" accept=".json">
                        </label>
                    </div>
                    <button id="import-clipboard-btn" class="btn btn-success import-option-btn">
                        <i class="fas fa-paste"></i>
                        <span>Paste from Clipboard</span>
                    </button>
                    <button id="import-sample-btn" class="btn btn-warning import-option-btn">
                        <i class="fas fa-seedling"></i>
                        <span>Load Sample Data</span>
                    </button>
                </div>

                <div id="export-content-section" style="display: none;">
                    <div class="code-block-title">
                        <span>Export Output</span>
                        <button id="copy-all-btn" class="btn btn-sm btn-primary">
                            <i class="fas fa-copy"></i> Copy All
                        </button>
                    </div>
                    <pre id="export-content" class="code-block">// Export content will appear here</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-export-import-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Mass Delete Confirmation Modal -->
    <div class="modal" id="mass-delete-modal">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--danger-color);">
                <h2>Confirm Mass Delete</h2>
                <button class="close-modal" id="close-mass-delete-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-count">0</strong> selected pages?</p>
                <p class="keyboard-hint" style="color: var(--danger-color); margin: 10px 0;">
                    <i class="fas fa-exclamation-triangle"></i> This action cannot be undone!
                </p>
                <div id="delete-preview" class="mass-delete-list">
                    <!-- Pages to delete will appear here -->
                </div>
                <div class="toggle-container" style="margin-top: 20px;">
                    <div class="toggle-label">
                        <i class="fas fa-sitemap"></i>
                        <span>Also delete child pages</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="delete-children">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-mass-delete-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-mass-delete-btn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete Selected Pages
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Notification message</span>
    </div>

    <!-- Context Menu -->
    <div id="context-menu"
        style="display: none; position: absolute; z-index: 1000; background-color: var(--node-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); min-width: 200px;">
        <div class="context-menu-item" data-action="edit"
            style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-edit"></i> Edit Page
        </div>
        <div class="context-menu-item" data-action="duplicate"
            style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-copy"></i> Duplicate
        </div>
        <div class="context-menu-item" data-action="make-root"
            style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-home"></i> Set as Home
        </div>
        <div class="context-menu-item" data-action="select-all"
            style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-square"></i> Select All
        </div>
        <div class="context-menu-item" data-action="deselect"
            style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-times"></i> Deselect All
        </div>
        <div class="context-menu-item" data-action="delete"
            style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--danger-color);">
            <i class="fas fa-trash"></i> Delete Selected
        </div>
    </div>

    <script>
        // Enhanced RouteMap Builder Pro - Mobile Optimized with Icon Support

        // ============================================
        // APP STATE AND DATA STRUCTURES
        // ============================================

        let appState = {
            pages: {},
            rootId: null,
            nextId: 1,
            selectedPageIds: [],
            isEditing: false,
            theme: localStorage.getItem('routemap-theme') || 'system',
            settings: {
                showGrid: true,
                autoLayout: false,
                multiSelectMode: true,
                showMetadata: true
            },
            history: {
                past: [],
                present: null,
                future: []
            },
            projectName: 'Untitled Project',
            selectionBox: {
                isSelecting: false,
                startX: 0,
                startY: 0,
                currentX: 0,
                currentY: 0
            },
            isMobile: window.innerWidth <= 900,
            sidebarVisible: window.innerWidth > 900
        };

        // ============================================
        // DOM ELEMENT REFERENCES
        // ============================================

        // Mobile elements
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const overlay = document.getElementById('overlay');
        const sidebar = document.getElementById('sidebar');

        // Icon picker elements
        const iconPickerModal = document.getElementById('icon-picker-modal');
        const openIconPickerBtn = document.getElementById('open-icon-picker');
        const closeIconPickerBtn = document.getElementById('close-icon-picker');
        const iconSearchInput = document.getElementById('icon-search-input');
        const iconCategories = document.getElementById('icon-categories');
        const iconGrid = document.getElementById('icon-grid');
        const pageIconInput = document.getElementById('page-icon-input');
        const iconPreview = document.getElementById('icon-preview');

        // Sidebar elements
        const pageNameInput = document.getElementById('page-name');
        const pageTypeSelect = document.getElementById('page-type');
        const parentPageSelect = document.getElementById('parent-page');
        const pageSlugInput = document.getElementById('page-slug');
        const pageDescriptionInput = document.getElementById('page-description');
        const pageProtectedCheckbox = document.getElementById('page-protected');
        const addPageBtn = document.getElementById('add-page-btn');
        const updatePageBtn = document.getElementById('update-page-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const pagesList = document.getElementById('pages-list');
        const pageCount = document.getElementById('page-count');
        const themeToggle = document.getElementById('theme-toggle');

        // Selection elements
        const selectionInfo = document.getElementById('selection-info');
        const selectedCount = document.getElementById('selected-count');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const massDeleteBtn = document.getElementById('mass-delete-btn');
        const massEditForm = document.getElementById('mass-edit-form');
        const singleEditForm = document.getElementById('single-edit-form');

        // Mass edit elements
        const massParentPageSelect = document.getElementById('mass-parent-page');
        const massPageTypeSelect = document.getElementById('mass-page-type');
        const applyMassEditBtn = document.getElementById('apply-mass-edit-btn');

        // Quick action buttons
        const selectAllBtn = document.getElementById('select-all-btn');
        const duplicateSelectedBtn = document.getElementById('duplicate-selected-btn');
        const groupSelectedBtn = document.getElementById('group-selected-btn');

        // Canvas elements
        const canvasArea = document.getElementById('canvas-area');
        const connectionsLayer = document.getElementById('connections-layer');
        const emptyState = document.getElementById('empty-state');
        const selectionBox = document.getElementById('selection-box');
        const selectionInfoCanvas = document.getElementById('selection-info-canvas');

        // Action buttons
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const saveProjectBtn = document.getElementById('save-project-btn');
        const loadProjectBtn = document.getElementById('load-project-btn');
        const resetBtn = document.getElementById('reset-btn');
        const createSampleBtn = document.getElementById('create-sample-btn');

        // Modal elements
        const exportImportModal = document.getElementById('export-import-modal');
        const exportImportModalTitle = document.getElementById('export-import-modal-title');
        const exportContent = document.getElementById('export-content');
        const exportContentSection = document.getElementById('export-content-section');
        const closeModalBtn = document.getElementById('close-modal');
        const closeExportImportBtn = document.getElementById('close-export-import-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportSitemapBtn = document.getElementById('export-sitemap-btn');
        const exportReactBtn = document.getElementById('export-react-btn');
        const exportNextjsBtn = document.getElementById('export-nextjs-btn');
        const importFileInput = document.getElementById('import-file');
        const importClipboardBtn = document.getElementById('import-clipboard-btn');
        const importSampleBtn = document.getElementById('import-sample-btn');
        const copyAllBtn = document.getElementById('copy-all-btn');

        // Mass delete modal
        const massDeleteModal = document.getElementById('mass-delete-modal');
        const closeMassDeleteModal = document.getElementById('close-mass-delete-modal');
        const cancelMassDeleteBtn = document.getElementById('cancel-mass-delete-btn');
        const confirmMassDeleteBtn = document.getElementById('confirm-mass-delete-btn');
        const deleteCount = document.getElementById('delete-count');
        const deletePreview = document.getElementById('delete-preview');
        const deleteChildrenCheckbox = document.getElementById('delete-children');

        // Settings elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const toggleGridCheckbox = document.getElementById('toggle-grid');
        const autoLayoutCheckbox = document.getElementById('auto-layout');
        const multiSelectModeCheckbox = document.getElementById('multi-select-mode');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');

        // Notification element
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        // Context menu
        const contextMenu = document.getElementById('context-menu');
        let contextMenuPosition = { x: 0, y: 0 };

        // ============================================
        // THEME MANAGEMENT (AUTO-DETECT SYSTEM THEME)
        // ============================================

        /**
         * Detects system theme preference
         * @returns {string} 'dark' or 'light'
         */
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        /**
         * Applies the current theme
         */
        function applyTheme() {
            let themeToApply = appState.theme;
            
            // If theme is set to 'system', use system preference
            if (themeToApply === 'system') {
                themeToApply = getSystemTheme();
            }
            
            if (themeToApply === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggle.title = 'Switch to Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggle.title = 'Switch to Dark Mode';
            }
            
            // Update theme toggle icon based on system/light/dark
            updateThemeToggleIcon();
        }

        /**
         * Updates theme toggle icon to show current theme state
         */
        function updateThemeToggleIcon() {
            if (appState.theme === 'system') {
                themeToggle.innerHTML = '<i class="fas fa-adjust"></i>';
                themeToggle.title = 'System Theme (Click to switch)';
            } else if (appState.theme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggle.title = 'Dark Mode (Click to switch)';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggle.title = 'Light Mode (Click to switch)';
            }
        }

        /**
         * Cycles through theme options: system -> light -> dark -> system
         */
        function toggleTheme() {
            const themes = ['system', 'light', 'dark'];
            const currentIndex = themes.indexOf(appState.theme);
            const nextIndex = (currentIndex + 1) % themes.length;
            
            appState.theme = themes[nextIndex];
            localStorage.setItem('routemap-theme', appState.theme);
            
            applyTheme();
            
            // Show notification
            let themeName = appState.theme === 'system' ? 'System' : 
                           appState.theme === 'dark' ? 'Dark' : 'Light';
            showNotification(`Theme set to ${themeName} mode`, 'info');
        }

        /**
         * Initializes theme based on saved preference or system
         */
        function initTheme() {
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (appState.theme === 'system') {
                    applyTheme();
                }
            });
            
            applyTheme();
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showNotification(message, type = 'success', duration = 3000) {
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);

            const icon = notification.querySelector('i');
            icon.className =
                type === 'success' ? 'fas fa-check-circle' :
                    type === 'error' ? 'fas fa-exclamation-circle' :
                        type === 'warning' ? 'fas fa-exclamation-triangle' :
                            'fas fa-info-circle';

            setTimeout(() => notification.classList.add('active'), 10);
            setTimeout(() => notification.classList.remove('active'), duration);
        }

        function saveToHistory() {
            if (appState.history.present) {
                appState.history.past.push(JSON.parse(JSON.stringify(appState.history.present)));
            }
            appState.history.present = JSON.parse(JSON.stringify(appState.pages));
            appState.history.future = [];
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            undoBtn.disabled = appState.history.past.length === 0;
            redoBtn.disabled = appState.history.future.length === 0;
        }

        function undo() {
            if (appState.history.past.length === 0) return;

            appState.history.future.unshift(appState.history.present);
            appState.history.present = appState.history.past.pop();
            appState.pages = JSON.parse(JSON.stringify(appState.history.present));

            if (!appState.pages[appState.rootId]) {
                const pageIds = Object.keys(appState.pages);
                appState.rootId = pageIds.length > 0 ? pageIds[0] : null;
            }

            appState.selectedPageIds = [];
            renderAll();
            updateUndoRedoButtons();
            showNotification('Undo successful', 'info');
        }

        function redo() {
            if (appState.history.future.length === 0) return;

            appState.history.past.push(appState.history.present);
            appState.history.present = appState.history.future.shift();
            appState.pages = JSON.parse(JSON.stringify(appState.history.present));

            if (!appState.pages[appState.rootId]) {
                const pageIds = Object.keys(appState.pages);
                appState.rootId = pageIds.length > 0 ? pageIds[0] : null;
            }

            appState.selectedPageIds = [];
            renderAll();
            updateUndoRedoButtons();
            showNotification('Redo successful', 'info');
        }

        // ============================================
        // PAGE DATA MANAGEMENT WITH ICON SUPPORT
        // ============================================

        function createPage(name, options = {}) {
            const id = `page-${appState.nextId++}`;
            const page = {
                id,
                name,
                icon: options.icon || 'fas fa-file',
                type: options.type || 'static',
                slug: options.slug || '',
                description: options.description || '',
                parentId: options.parentId || null,
                childrenIds: [],
                position: options.position || {
                    x: 100 + Math.random() * 400,
                    y: 100 + Math.random() * 300
                },
                protected: options.protected || false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                metadata: options.metadata || {}
            };

            if (Object.keys(appState.pages).length === 0) {
                appState.rootId = id;
            }

            if (page.parentId && appState.pages[page.parentId]) {
                appState.pages[page.parentId].childrenIds.push(id);
            }

            appState.pages[id] = page;
            updatePageCount();
            return page;
        }

        function updatePage(id, updates) {
            const page = appState.pages[id];
            if (!page) return;

            const oldParentId = page.parentId;

            Object.keys(updates).forEach(key => {
                if (key !== 'id' && key !== 'childrenIds') {
                    page[key] = updates[key];
                }
            });

            page.updatedAt = new Date().toISOString();

            if (updates.parentId !== undefined && updates.parentId !== oldParentId) {
                if (oldParentId && appState.pages[oldParentId]) {
                    const index = appState.pages[oldParentId].childrenIds.indexOf(id);
                    if (index > -1) {
                        appState.pages[oldParentId].childrenIds.splice(index, 1);
                    }
                }

                page.parentId = updates.parentId;
                if (updates.parentId && appState.pages[updates.parentId]) {
                    appState.pages[updates.parentId].childrenIds.push(id);
                }
            }
        }

        function deletePage(id, deleteChildren = true) {
            const page = appState.pages[id];
            if (!page) return;

            if (Object.keys(appState.pages).length === 1) {
                delete appState.pages[id];
                appState.rootId = null;
                updatePageCount();
                return;
            }

            if (id === appState.rootId) {
                let newRootId = null;

                for (const pageId in appState.pages) {
                    if (pageId !== id && (!appState.pages[pageId].parentId || appState.pages[pageId].parentId === id)) {
                        newRootId = pageId;
                        break;
                    }
                }

                if (!newRootId) {
                    for (const pageId in appState.pages) {
                        if (pageId !== id) {
                            newRootId = pageId;
                            break;
                        }
                    }
                }

                if (newRootId) {
                    appState.rootId = newRootId;
                    appState.pages[newRootId].parentId = null;
                    showNotification(`Home page changed to "${appState.pages[newRootId].name}"`, 'info');
                }
            }

            if (deleteChildren) {
                const childrenToDelete = [...page.childrenIds];
                childrenToDelete.forEach(childId => {
                    deletePage(childId, true);
                });
            } else {
                page.childrenIds.forEach(childId => {
                    const childPage = appState.pages[childId];
                    if (childPage) {
                        childPage.parentId = page.parentId;
                        if (page.parentId && appState.pages[page.parentId]) {
                            appState.pages[page.parentId].childrenIds.push(childId);
                        }
                    }
                });
            }

            if (page.parentId && appState.pages[page.parentId]) {
                const parent = appState.pages[page.parentId];
                const index = parent.childrenIds.indexOf(id);
                if (index > -1) {
                    parent.childrenIds.splice(index, 1);
                }
            }

            delete appState.pages[id];

            const selectionIndex = appState.selectedPageIds.indexOf(id);
            if (selectionIndex > -1) {
                appState.selectedPageIds.splice(selectionIndex, 1);
            }

            updatePageCount();
        }

        function deletePages(pageIds, deleteChildren = true) {
            const idsToDelete = [...pageIds];
            idsToDelete.forEach(id => {
                deletePage(id, deleteChildren);
            });
            appState.selectedPageIds = [];
            updateSelectionUI();
        }

        function duplicatePage(id) {
            const originalPage = appState.pages[id];
            if (!originalPage) return null;

            const idMap = {};

            function duplicatePageRecursive(pageId, newParentId = null) {
                const page = appState.pages[pageId];
                const newPage = createPage(`${page.name} Copy`, {
                    icon: page.icon,
                    type: page.type,
                    slug: page.slug,
                    description: page.description,
                    parentId: newParentId,
                    position: {
                        x: page.position.x + 30,
                        y: page.position.y + 30
                    },
                    protected: page.protected,
                    metadata: { ...page.metadata }
                });

                idMap[pageId] = newPage.id;

                page.childrenIds.forEach(childId => {
                    duplicatePageRecursive(childId, newPage.id);
                });

                return newPage.id;
            }

            const newPageId = duplicatePageRecursive(id, originalPage.parentId);
            updatePageCount();
            return newPageId;
        }

        function duplicatePages(pageIds) {
            const newPageIds = [];
            pageIds.forEach(id => {
                const newId = duplicatePage(id);
                if (newId) {
                    newPageIds.push(newId);
                }
            });
            return newPageIds;
        }

        function getPagePath(id) {
            const page = appState.pages[id];
            if (!page) return '';

            if (id === appState.rootId) return page.slug || page.name.toLowerCase();

            let path = page.slug || page.name.toLowerCase();
            let currentPage = page;

            while (currentPage.parentId) {
                currentPage = appState.pages[currentPage.parentId];
                const parentSlug = currentPage.slug || currentPage.name.toLowerCase();
                path = `${parentSlug}/${path}`;
            }

            return path;
        }

        function updatePageCount() {
            const count = Object.keys(appState.pages).length;
            pageCount.textContent = `${count} page${count !== 1 ? 's' : ''}`;
        }

        // ============================================
        // ICON PICKER SYSTEM (FIXED CLOSING ISSUE)
        // ============================================

        const iconLibrary = {
            common: [
                'fas fa-home', 'fas fa-file', 'fas fa-folder', 'fas fa-globe', 'fas fa-user',
                'fas fa-cog', 'fas fa-info-circle', 'fas fa-question-circle', 'fas fa-envelope'
            ],
            navigation: [
                'fas fa-sitemap', 'fas fa-bars', 'fas fa-arrow-right', 'fas fa-arrow-left',
                'fas fa-chevron-right', 'fas fa-chevron-left', 'fas fa-external-link-alt'
            ],
            content: [
                'fas fa-newspaper', 'fas fa-blog', 'fas fa-image', 'fas fa-video',
                'fas fa-music', 'fas fa-book', 'fas fa-pen', 'fas fa-edit'
            ],
            social: [
                'fab fa-facebook', 'fab fa-twitter', 'fab fa-instagram', 'fab fa-linkedin',
                'fab fa-youtube', 'fab fa-github', 'fab fa-discord', 'fab fa-whatsapp'
            ],
            custom: [
                'â­', 'ðŸ”¥', 'ðŸš€', 'ðŸ’Ž', 'âœ¨', 'ðŸŽ¯', 'ðŸ“±', 'ðŸ’»', 'ðŸŒ', 'ðŸ“Š',
                'ðŸ”’', 'ðŸ”‘', 'ðŸ“ˆ', 'ðŸ“‰', 'ðŸ›’', 'ðŸ“ž', 'ðŸ“§', 'ðŸ“', 'ðŸ“…', 'â°'
            ]
        };

        function populateIconGrid(category = 'all', searchTerm = '') {
            iconGrid.innerHTML = '';
            
            let icons = [];
            if (category === 'all') {
                Object.values(iconLibrary).forEach(cat => {
                    icons = icons.concat(cat);
                });
            } else if (iconLibrary[category]) {
                icons = iconLibrary[category];
            }

            // Filter by search term
            if (searchTerm) {
                icons = icons.filter(icon => 
                    icon.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Display icons
            icons.forEach(icon => {
                const iconItem = document.createElement('div');
                iconItem.className = 'icon-item';
                iconItem.dataset.icon = icon;
                
                // Check if it's a Font Awesome icon or custom text
                if (icon.startsWith('fa')) {
                    iconItem.innerHTML = `
                        <i class="${icon}"></i>
                        <div class="icon-name">${icon.split(' ')[1]?.replace('fa-', '') || icon}</div>
                    `;
                } else {
                    // Custom text/emoji
                    iconItem.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 8px;">${icon}</div>
                        <div class="icon-name">Custom</div>
                    `;
                }

                iconItem.addEventListener('click', () => {
                    // Remove selected class from all icons
                    document.querySelectorAll('.icon-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked icon
                    iconItem.classList.add('selected');
                    
                    // Update the icon input and preview
                    pageIconInput.value = icon;
                    updateIconPreview(icon);
                    
                    // Close the picker after selection (FIXED)
                    setTimeout(() => {
                        closeIconPicker();
                    }, 300);
                });

                iconGrid.appendChild(iconItem);
            });

            // If no icons found, show message
            if (icons.length === 0) {
                iconGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                        No icons found for "${searchTerm}"
                    </div>
                `;
            }
        }

        function updateIconPreview(iconValue) {
            if (iconValue.startsWith('fa')) {
                // Font Awesome icon
                iconPreview.className = iconValue;
                iconPreview.style.display = 'inline-block';
                iconPreview.textContent = '';
            } else {
                // Custom text/emoji
                iconPreview.className = '';
                iconPreview.textContent = iconValue;
                iconPreview.style.display = 'inline-block';
            }
        }

        function openIconPicker() {
            iconPickerModal.classList.add('active');
            populateIconGrid('all');
            
            // Set initial search
            iconSearchInput.value = '';
            
            // Close sidebar on mobile when opening picker
            if (appState.isMobile) {
                closeMobileSidebar();
            }
        }

        function closeIconPicker() {
            iconPickerModal.classList.remove('active');
        }

        // ============================================
        // SELECTION MANAGEMENT
        // ============================================

        function togglePageSelection(id, isCtrlPressed = false) {
            if (!appState.settings.multiSelectMode) {
                if (appState.selectedPageIds[0] === id && appState.selectedPageIds.length === 1) {
                    appState.selectedPageIds = [];
                } else {
                    appState.selectedPageIds = [id];
                }
            } else if (isCtrlPressed) {
                const index = appState.selectedPageIds.indexOf(id);
                if (index > -1) {
                    appState.selectedPageIds.splice(index, 1);
                } else {
                    appState.selectedPageIds.push(id);
                }
            } else {
                appState.selectedPageIds = [id];
            }

            updateSelectionUI();
            
            // Close sidebar on mobile after selection
            if (appState.isMobile && appState.selectedPageIds.length === 1) {
                closeMobileSidebar();
            }
        }

        function selectAllPages() {
            appState.selectedPageIds = Object.keys(appState.pages);
            updateSelectionUI();
            showNotification(`Selected all ${appState.selectedPageIds.length} pages`, 'info');
        }

        function deselectAllPages() {
            appState.selectedPageIds = [];
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const selectedCountValue = appState.selectedPageIds.length;

            if (selectedCountValue > 0) {
                selectionInfo.classList.remove('hidden');
                selectedCount.textContent = selectedCountValue;
                selectionInfoCanvas.textContent = `${selectedCountValue} page${selectedCountValue !== 1 ? 's' : ''} selected`;

                if (selectedCountValue === 1) {
                    massEditForm.classList.add('hidden');
                    singleEditForm.style.display = 'block';

                    const pageId = appState.selectedPageIds[0];
                    const page = appState.pages[pageId];
                    if (page) {
                        pageNameInput.value = page.name;
                        pageIconInput.value = page.icon;
                        updateIconPreview(page.icon);
                        pageTypeSelect.value = page.type;
                        pageSlugInput.value = page.slug || '';
                        pageDescriptionInput.value = page.description || '';
                        pageProtectedCheckbox.checked = page.protected || false;

                        addPageBtn.style.display = 'none';
                        updatePageBtn.style.display = 'flex';
                        cancelEditBtn.style.display = 'flex';
                        appState.isEditing = true;
                    }
                } else {
                    singleEditForm.style.display = 'none';
                    massEditForm.classList.remove('hidden');

                    addPageBtn.style.display = 'flex';
                    updatePageBtn.style.display = 'none';
                    cancelEditBtn.style.display = 'none';
                    appState.isEditing = false;

                    pageNameInput.value = '';
                    pageIconInput.value = 'fas fa-file';
                    updateIconPreview('fas fa-file');
                    pageSlugInput.value = '';
                    pageDescriptionInput.value = '';
                    pageProtectedCheckbox.checked = false;
                }
            } else {
                selectionInfo.classList.add('hidden');
                singleEditForm.style.display = 'block';
                massEditForm.classList.add('hidden');

                addPageBtn.style.display = 'flex';
                updatePageBtn.style.display = 'none';
                cancelEditBtn.style.display = 'none';
                appState.isEditing = false;

                pageNameInput.value = '';
                pageIconInput.value = 'fas fa-file';
                updateIconPreview('fas fa-file');
                pageSlugInput.value = '';
                pageDescriptionInput.value = '';
                pageProtectedCheckbox.checked = false;

                selectionInfoCanvas.textContent = 'No selection';
            }

            updateParentPageDropdown();
            updateMassParentPageDropdown();
            renderPagesList();
            renderPageNodes();
        }

        function applyMassEdit() {
            const selectedIds = appState.selectedPageIds;
            if (selectedIds.length === 0) return;

            const parentId = massParentPageSelect.value || null;
            const pageType = massPageTypeSelect.value;
            const protectedValue = document.querySelector('input[name="mass-protected"]:checked').value;

            let changesMade = false;

            selectedIds.forEach(id => {
                const page = appState.pages[id];
                if (!page) return;

                const updates = {};

                if (parentId !== '' && parentId !== page.parentId && parentId !== id) {
                    updates.parentId = parentId;
                    changesMade = true;
                }

                if (pageType !== '' && pageType !== page.type) {
                    updates.type = pageType;
                    changesMade = true;
                }

                if (protectedValue !== '') {
                    const newProtected = protectedValue === 'true';
                    if (newProtected !== page.protected) {
                        updates.protected = newProtected;
                        changesMade = true;
                    }
                }

                if (Object.keys(updates).length > 0) {
                    updatePage(id, updates);
                }
            });

            if (changesMade) {
                saveToHistory();
                renderAll();
                showNotification(`Updated ${selectedIds.length} pages`, 'success');
            } else {
                showNotification('No changes made', 'info');
            }
        }

        function showMassDeleteModal() {
            const selectedIds = appState.selectedPageIds;
            if (selectedIds.length === 0) return;

            deleteCount.textContent = selectedIds.length;
            deletePreview.innerHTML = '';

            selectedIds.forEach(id => {
                const page = appState.pages[id];
                if (page) {
                    const div = document.createElement('div');
                    div.className = 'mass-delete-item';
                    div.innerHTML = `
                        <span>${page.name}</span>
                        <span style="color: var(--gray-color); font-size: 0.8rem;">${page.childrenIds.length} children</span>
                    `;
                    deletePreview.appendChild(div);
                }
            });

            massDeleteModal.classList.add('active');
            
            // Close sidebar on mobile when opening modal
            if (appState.isMobile) {
                closeMobileSidebar();
            }
        }

        // ============================================
        // UI RENDERING FUNCTIONS
        // ============================================

        function renderPagesList() {
            pagesList.innerHTML = '';

            const sortedPageIds = Object.keys(appState.pages).sort((a, b) => {
                if (a === appState.rootId) return -1;
                if (b === appState.rootId) return 1;
                return appState.pages[a].name.localeCompare(appState.pages[b].name);
            });

            sortedPageIds.forEach(id => {
                const page = appState.pages[id];
                const listItem = document.createElement('li');

                let selectionClass = '';
                if (appState.selectedPageIds.includes(id)) {
                    selectionClass = appState.selectedPageIds.length > 1 ? 'multi-selected' : 'selected';
                }

                listItem.className = `page-item ${selectionClass}`;
                listItem.dataset.id = id;

                // Determine if icon is Font Awesome or custom text
                let iconHTML = '';
                if (page.icon.startsWith('fa')) {
                    iconHTML = `<i class="page-icon ${page.icon}"></i>`;
                } else {
                    iconHTML = `<span class="page-icon">${page.icon}</span>`;
                }

                listItem.innerHTML = `
                    <div class="page-name">
                        ${iconHTML}
                        <div class="page-text">
                            ${page.name}
                            ${page.protected ? '<i class="fas fa-shield-alt" style="color: var(--warning-color); font-size: 0.8rem; margin-left: 5px;"></i>' : ''}
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="page-action-btn edit-page" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="page-action-btn delete-page" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                listItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.page-actions')) {
                        const isCtrlPressed = e.ctrlKey || e.metaKey;
                        togglePageSelection(id, isCtrlPressed);
                    }
                });

                listItem.querySelector('.edit-page').addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePageSelection(id, false);
                });

                listItem.querySelector('.delete-page').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete page "${page.name}" and all its children?`)) {
                        deletePage(id, true);
                        saveToHistory();
                        renderAll();
                        showNotification(`Page "${page.name}" deleted`, 'success');
                    }
                });

                pagesList.appendChild(listItem);
            });

            updateParentPageDropdown();
            updateMassParentPageDropdown();
        }

        function updateParentPageDropdown() {
            parentPageSelect.innerHTML = '<option value="">None (Top Level)</option>';

            Object.keys(appState.pages).forEach(id => {
                if (appState.selectedPageIds.length === 1 && id === appState.selectedPageIds[0]) return;

                const page = appState.pages[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = page.name + (id === appState.rootId ? ' (Home)' : '');
                parentPageSelect.appendChild(option);
            });

            if (appState.selectedPageIds.length === 1) {
                const pageId = appState.selectedPageIds[0];
                const page = appState.pages[pageId];
                if (page) {
                    parentPageSelect.value = page.parentId || '';
                }
            }
        }

        function updateMassParentPageDropdown() {
            massParentPageSelect.innerHTML = '<option value="">Keep Current Parent</option><option value="">None (Top Level)</option>';

            Object.keys(appState.pages).forEach(id => {
                if (appState.selectedPageIds.includes(id)) return;

                const page = appState.pages[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = page.name + (id === appState.rootId ? ' (Home)' : '');
                massParentPageSelect.appendChild(option);
            });
        }

        function renderPageNodes() {
            document.querySelectorAll('.page-node').forEach(node => node.remove());

            connectionsLayer.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary-color)" />
                    </marker>
                    <marker id="dashed-arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)" />
                    </marker>
                </defs>
            `;

            if (Object.keys(appState.pages).length > 0) {
                emptyState.style.display = 'none';
            } else {
                emptyState.style.display = 'flex';
                return;
            }

            Object.values(appState.pages).forEach(page => {
                createPageNode(page);
            });

            Object.values(appState.pages).forEach(page => {
                page.childrenIds.forEach(childId => {
                    createConnection(page.id, childId);
                });
            });
        }

        function createPageNode(page) {
            const node = document.createElement('div');

            let selectionClass = '';
            if (appState.selectedPageIds.includes(page.id)) {
                selectionClass = appState.selectedPageIds.length > 1 ? 'multi-selected' : 'selected';
            }

            node.className = `page-node ${page.type} ${selectionClass}`;
            node.id = `node-${page.id}`;
            node.dataset.id = page.id;

            node.style.left = `${page.position.x}px`;
            node.style.top = `${page.position.y}px`;

            const path = getPagePath(page.id);

            let badgeClass = 'page-node-static';
            let badgeText = 'Static';

            if (page.type === 'dynamic') {
                badgeClass = 'page-node-dynamic';
                badgeText = 'Dynamic';
            } else if (page.type === 'api') {
                badgeClass = 'page-node-dynamic';
                badgeText = 'API';
            } else if (page.type === 'auth') {
                badgeClass = 'page-node-home';
                badgeText = 'Auth';
            }

            if (page.id === appState.rootId) {
                badgeClass = 'page-node-home';
                badgeText = 'Home';
            }

            // Create icon display
            let iconDisplay = '';
            if (page.icon.startsWith('fa')) {
                iconDisplay = `<i class="page-node-title-icon ${page.icon}"></i>`;
            } else {
                iconDisplay = `<span class="page-node-title-icon">${page.icon}</span>`;
            }

            node.innerHTML = `
                <div class="page-node-header">
                    <div class="page-node-title">
                        ${iconDisplay}
                        <div class="page-node-title-text">${page.name}</div>
                    </div>
                    <div class="page-node-badge ${badgeClass}">${badgeText}</div>
                </div>
                <div class="page-node-path" title="/${path}">/${path}</div>
                ${appState.settings.showMetadata ? `
                    <div class="page-node-meta">
                        <span>${page.type}</span>
                        <span>${page.protected ? '<i class="fas fa-lock"></i>' : '<i class="fas fa-unlock"></i>'}</span>
                    </div>
                    ${page.description ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">${page.description}</div>` : ''}
                ` : ''}
                ${page.childrenIds.length > 0 ? `
                    <div class="page-node-children">
                        <i class="fas fa-sitemap"></i>
                        ${page.childrenIds.length} child${page.childrenIds.length !== 1 ? 'ren' : ''}
                    </div>
                ` : ''}
            `;

            setupDragAndDrop(node);

            node.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCtrlPressed = e.ctrlKey || e.metaKey;
                togglePageSelection(page.id, isCtrlPressed);
            });

            node.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showContextMenu(e, page.id);
            });

            // Touch events for mobile
            node.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                const touch = e.touches[0];
                const simulatedEvent = new MouseEvent('click', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true
                });
                node.dispatchEvent(simulatedEvent);
            });

            canvasArea.appendChild(node);
        }

        function createConnection(parentId, childId) {
            const parentNode = document.getElementById(`node-${parentId}`);
            const childNode = document.getElementById(`node-${childId}`);

            if (!parentNode || !childNode) return;

            const parentRect = parentNode.getBoundingClientRect();
            const childRect = childNode.getBoundingClientRect();
            const canvasRect = canvasArea.getBoundingClientRect();

            const parentX = parentRect.left - canvasRect.left + parentRect.width / 2;
            const parentY = parentRect.top - canvasRect.top + parentRect.height / 2;
            const childX = childRect.left - canvasRect.left + childRect.width / 2;
            const childY = childRect.top - canvasRect.top + childRect.height / 2;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', parentX);
            line.setAttribute('y1', parentY);
            line.setAttribute('x2', childX);
            line.setAttribute('y2', childY);

            const parentPage = appState.pages[parentId];
            if (parentPage.type === 'dynamic' || parentPage.type === 'api') {
                line.setAttribute('stroke', 'var(--accent-color)');
                line.setAttribute('stroke-dasharray', '5,5');
                line.setAttribute('marker-end', 'url(#dashed-arrowhead)');
            } else {
                line.setAttribute('stroke', 'var(--primary-color)');
                line.setAttribute('marker-end', 'url(#arrowhead)');
            }

            line.setAttribute('stroke-width', '2');
            connectionsLayer.appendChild(line);
        }

        function renderAll() {
            renderPagesList();
            renderPageNodes();
            updateSelectionUI();
        }

        // ============================================
        // DRAG AND DROP FUNCTIONALITY (MOBILE OPTIMIZED)
        // ============================================

        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let draggedElement = null;
        let draggedPageIds = [];

        function setupDragAndDrop(node) {
            node.addEventListener('mousedown', startDrag);
            node.addEventListener('touchstart', startDragTouch, { passive: false });
        }

        function startDrag(e) {
            if (e.target.closest('button') || e.target.tagName === 'BUTTON') return;
            if (appState.isMobile && e.type === 'mousedown') return;

            e.preventDefault();
            e.stopPropagation();

            isDragging = true;
            draggedElement = e.currentTarget;
            const pageId = draggedElement.dataset.id;

            if (appState.selectedPageIds.includes(pageId) && appState.selectedPageIds.length > 1) {
                draggedPageIds = [...appState.selectedPageIds];
            } else {
                draggedPageIds = [pageId];
                if (!appState.selectedPageIds.includes(pageId)) {
                    togglePageSelection(pageId, false);
                }
            }

            const rect = draggedElement.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            draggedElement.classList.add('dragging');
            
            // Prevent text selection while dragging
            document.body.style.userSelect = 'none';
        }

        function startDragTouch(e) {
            if (e.target.closest('button') || e.target.tagName === 'BUTTON') return;
            
            e.preventDefault();
            e.stopPropagation();

            isDragging = true;
            draggedElement = e.currentTarget;
            const pageId = draggedElement.dataset.id;

            if (appState.selectedPageIds.includes(pageId) && appState.selectedPageIds.length > 1) {
                draggedPageIds = [...appState.selectedPageIds];
            } else {
                draggedPageIds = [pageId];
                if (!appState.selectedPageIds.includes(pageId)) {
                    togglePageSelection(pageId, false);
                }
            }

            const touch = e.touches[0];
            const rect = draggedElement.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;

            document.addEventListener('touchmove', dragTouch, { passive: false });
            document.addEventListener('touchend', stopDrag);
            document.addEventListener('touchcancel', stopDrag);

            draggedElement.classList.add('dragging');
            
            // Prevent scroll while dragging on mobile
            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
        }

        function drag(e) {
            if (!isDragging || !draggedElement) return;

            e.preventDefault();

            const canvasRect = canvasArea.getBoundingClientRect();
            const deltaX = e.clientX - dragOffsetX - (draggedElement.offsetLeft || 0);
            const deltaY = e.clientY - dragOffsetY - (draggedElement.offsetTop || 0);

            draggedPageIds.forEach(pageId => {
                const page = appState.pages[pageId];
                if (page) {
                    const node = document.getElementById(`node-${pageId}`);
                    if (node) {
                        const newX = Math.max(0, Math.min(page.position.x + deltaX, canvasRect.width - node.offsetWidth));
                        const newY = Math.max(0, Math.min(page.position.y + deltaY, canvasRect.height - node.offsetHeight));

                        node.style.left = `${newX}px`;
                        node.style.top = `${newY}px`;

                        page.position = { x: newX, y: newY };
                    }
                }
            });

            dragOffsetX = e.clientX - draggedElement.getBoundingClientRect().left;
            dragOffsetY = e.clientY - draggedElement.getBoundingClientRect().top;

            renderPageNodes();
        }

        function dragTouch(e) {
            if (!isDragging || !draggedElement) return;

            e.preventDefault();
            const touch = e.touches[0];

            const canvasRect = canvasArea.getBoundingClientRect();
            const deltaX = touch.clientX - dragOffsetX - (draggedElement.offsetLeft || 0);
            const deltaY = touch.clientY - dragOffsetY - (draggedElement.offsetTop || 0);

            draggedPageIds.forEach(pageId => {
                const page = appState.pages[pageId];
                if (page) {
                    const node = document.getElementById(`node-${pageId}`);
                    if (node) {
                        const newX = Math.max(0, Math.min(page.position.x + deltaX, canvasRect.width - node.offsetWidth));
                        const newY = Math.max(0, Math.min(page.position.y + deltaY, canvasRect.height - node.offsetHeight));

                        node.style.left = `${newX}px`;
                        node.style.top = `${newY}px`;

                        page.position = { x: newX, y: newY };
                    }
                }
            });

            dragOffsetX = touch.clientX - draggedElement.getBoundingClientRect().left;
            dragOffsetY = touch.clientY - draggedElement.getBoundingClientRect().top;

            renderPageNodes();
        }

        function stopDrag() {
            if (!isDragging) return;

            isDragging = false;

            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }

            draggedPageIds = [];

            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
            document.removeEventListener('touchcancel', stopDrag);

            // Restore scrolling and selection
            document.body.style.overflow = '';
            document.body.style.userSelect = '';

            saveToHistory();
        }

        // ============================================
        // MOBILE SIDEBAR MANAGEMENT
        // ============================================

        function toggleMobileSidebar() {
            if (appState.isMobile) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                if (sidebar.classList.contains('active')) {
                    mobileSidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileSidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }
        }

        function openMobileSidebar() {
            if (appState.isMobile) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                mobileSidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
            }
        }

        function closeMobileSidebar() {
            if (appState.isMobile) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                mobileSidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
            }
        }

        // ============================================
        // EVENT LISTENER SETUP
        // ============================================

        function setupEventListeners() {
            // Mobile sidebar toggle
            mobileSidebarToggle.addEventListener('click', toggleMobileSidebar);
            overlay.addEventListener('click', closeMobileSidebar);

            // Icon picker events (FIXED)
            openIconPickerBtn.addEventListener('click', openIconPicker);
            closeIconPickerBtn.addEventListener('click', closeIconPicker);
            
            // Icon search
            iconSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const activeCategory = document.querySelector('.icon-category-btn.active')?.dataset.category || 'all';
                populateIconGrid(activeCategory, searchTerm);
            });
            
            // Icon categories
            iconCategories.addEventListener('click', (e) => {
                if (e.target.classList.contains('icon-category-btn')) {
                    // Remove active class from all buttons
                    document.querySelectorAll('.icon-category-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    e.target.classList.add('active');
                    
                    // Populate grid with selected category
                    const category = e.target.dataset.category;
                    const searchTerm = iconSearchInput.value;
                    populateIconGrid(category, searchTerm);
                }
            });
            
            // Icon input change
            pageIconInput.addEventListener('input', (e) => {
                updateIconPreview(e.target.value);
            });

            // Add page button
            addPageBtn.addEventListener('click', () => {
                const pageName = pageNameInput.value.trim();
                if (!pageName) {
                    showNotification('Please enter a page name', 'error');
                    return;
                }

                const icon = pageIconInput.value.trim() || 'fas fa-file';
                const parentId = parentPageSelect.value || null;
                const pageType = pageTypeSelect.value;
                const slug = pageSlugInput.value.trim();
                const description = pageDescriptionInput.value.trim();
                const protectedRoute = pageProtectedCheckbox.checked;

                createPage(pageName, {
                    icon,
                    type: pageType,
                    slug,
                    description,
                    parentId,
                    protected: protectedRoute
                });

                saveToHistory();
                renderAll();
                showNotification(`Page "${pageName}" added`, 'success');

                // Clear form
                pageNameInput.value = '';
                pageIconInput.value = 'fas fa-file';
                updateIconPreview('fas fa-file');
                pageSlugInput.value = '';
                pageDescriptionInput.value = '';
                pageProtectedCheckbox.checked = false;
                
                // Close sidebar on mobile after adding
                if (appState.isMobile) {
                    closeMobileSidebar();
                }
            });

            // Update page button
            updatePageBtn.addEventListener('click', () => {
                if (appState.selectedPageIds.length !== 1) return;

                const pageId = appState.selectedPageIds[0];
                const pageName = pageNameInput.value.trim();
                if (!pageName) {
                    showNotification('Please enter a page name', 'error');
                    return;
                }

                const icon = pageIconInput.value.trim() || 'fas fa-file';
                const parentId = parentPageSelect.value || null;
                const pageType = pageTypeSelect.value;
                const slug = pageSlugInput.value.trim();
                const description = pageDescriptionInput.value.trim();
                const protectedRoute = pageProtectedCheckbox.checked;

                if (parentId === pageId) {
                    showNotification('A page cannot be its own parent', 'error');
                    return;
                }

                updatePage(pageId, {
                    name: pageName,
                    icon,
                    type: pageType,
                    slug,
                    description,
                    parentId,
                    protected: protectedRoute
                });

                saveToHistory();
                renderAll();
                showNotification(`Page "${pageName}" updated`, 'success');
                
                // Close sidebar on mobile after updating
                if (appState.isMobile) {
                    closeMobileSidebar();
                }
            });

            // Cancel edit button
            cancelEditBtn.addEventListener('click', () => {
                deselectAllPages();
            });

            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);

            // Selection buttons
            deselectAllBtn.addEventListener('click', deselectAllPages);
            massDeleteBtn.addEventListener('click', showMassDeleteModal);
            applyMassEditBtn.addEventListener('click', applyMassEdit);

            // Quick action buttons
            selectAllBtn.addEventListener('click', selectAllPages);
            duplicateSelectedBtn.addEventListener('click', () => {
                if (appState.selectedPageIds.length === 0) {
                    showNotification('Please select pages to duplicate', 'warning');
                    return;
                }

                const newIds = duplicatePages(appState.selectedPageIds);
                saveToHistory();
                renderAll();
                showNotification(`Duplicated ${newIds.length} pages`, 'success');
            });

            groupSelectedBtn.addEventListener('click', () => {
                if (appState.selectedPageIds.length < 2) {
                    showNotification('Please select at least 2 pages to group', 'warning');
                    return;
                }

                const groupPage = createPage('Group', {
                    icon: 'fas fa-object-group',
                    type: 'static',
                    description: 'Group of pages',
                    position: {
                        x: 100 + Math.random() * 400,
                        y: 100 + Math.random() * 300
                    }
                });

                appState.selectedPageIds.forEach(pageId => {
                    const page = appState.pages[pageId];
                    if (page && page.id !== groupPage.id) {
                        page.parentId = groupPage.id;
                        groupPage.childrenIds.push(pageId);
                    }
                });

                saveToHistory();
                renderAll();
                showNotification(`Grouped ${appState.selectedPageIds.length} pages`, 'success');
            });

            // Import/Export buttons
            importBtn.addEventListener('click', () => {
                exportImportModalTitle.textContent = 'Import Project';
                exportContentSection.style.display = 'none';
                exportImportModal.classList.add('active');
                
                if (appState.isMobile) {
                    closeMobileSidebar();
                }
            });

            exportBtn.addEventListener('click', () => {
                exportImportModalTitle.textContent = 'Export Project';
                exportContentSection.style.display = 'none';
                exportImportModal.classList.add('active');
                
                if (appState.isMobile) {
                    closeMobileSidebar();
                }
            });

            // Export options
            exportJsonBtn.addEventListener('click', () => {
                const jsonStructure = convertToJSONStructure();
                const jsonString = JSON.stringify(jsonStructure, null, 2);
                showExportModal('Export as JSON', jsonString);
            });

            exportSitemapBtn.addEventListener('click', () => {
                const sitemap = generateSitemap();
                showExportModal('Export as Sitemap', sitemap);
            });

            exportReactBtn.addEventListener('click', () => {
                const reactRoutes = generateReactRoutes();
                showExportModal('Export as React Router', reactRoutes);
            });

            exportNextjsBtn.addEventListener('click', () => {
                const nextjsRoutes = generateNextJSRoutes();
                showExportModal('Export as Next.js Routes', nextjsRoutes);
            });

            // Import options
            importFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFile(e.target.files[0]);
                    exportImportModal.classList.remove('active');
                }
            });

            importClipboardBtn.addEventListener('click', () => {
                importFromClipboard();
                exportImportModal.classList.remove('active');
            });

            importSampleBtn.addEventListener('click', () => {
                createSampleStructure();
                exportImportModal.classList.remove('active');
            });

            // Copy all button
            copyAllBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(exportContent.textContent).then(() => {
                    showNotification('Copied to clipboard', 'success');
                }).catch(err => {
                    showNotification('Failed to copy', 'error');
                });
            });

            // Save/Load/Reset buttons
            saveProjectBtn.addEventListener('click', () => {
                const projectData = {
                    pages: appState.pages,
                    rootId: appState.rootId,
                    nextId: appState.nextId,
                    projectName: appState.projectName,
                    exportDate: new Date().toISOString()
                };

                const jsonString = JSON.stringify(projectData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${appState.projectName || 'routemap'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Project saved', 'success');
            });

            loadProjectBtn.addEventListener('click', () => {
                importFileInput.click();
            });

            resetBtn.addEventListener('click', () => {
                if (Object.keys(appState.pages).length === 0) return;

                if (confirm('Are you sure you want to clear all pages? This cannot be undone.')) {
                    appState.pages = {};
                    appState.rootId = null;
                    appState.nextId = 1;
                    appState.selectedPageIds = [];
                    appState.isEditing = false;

                    renderAll();
                    showNotification('Project cleared', 'info');
                }
            });

            // Create sample button
            createSampleBtn.addEventListener('click', createSampleStructure);

            // Mass delete modal buttons
            closeMassDeleteModal.addEventListener('click', () => {
                massDeleteModal.classList.remove('active');
            });

            cancelMassDeleteBtn.addEventListener('click', () => {
                massDeleteModal.classList.remove('active');
            });

            confirmMassDeleteBtn.addEventListener('click', () => {
                const deleteChildren = deleteChildrenCheckbox.checked;
                deletePages(appState.selectedPageIds, deleteChildren);
                saveToHistory();
                renderAll();
                massDeleteModal.classList.remove('active');
                showNotification(`Deleted ${appState.selectedPageIds.length} pages`, 'success');
            });

            // Modal buttons
            closeModalBtn.addEventListener('click', () => {
                exportImportModal.classList.remove('active');
            });

            closeExportImportBtn.addEventListener('click', () => {
                exportImportModal.classList.remove('active');
            });

            // Settings
            settingsBtn.addEventListener('click', () => {
                settingsMenu.classList.toggle('active');
            });

            toggleGridCheckbox.addEventListener('change', toggleGrid);
            autoLayoutCheckbox.addEventListener('change', () => {
                appState.settings.autoLayout = autoLayoutCheckbox.checked;
                if (appState.settings.autoLayout) {
                    showNotification('Auto-layout would arrange nodes automatically', 'info');
                }
            });

            multiSelectModeCheckbox.addEventListener('change', toggleMultiSelectMode);

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            // Context menu
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleContextMenuAction(action);
                });
            });

            // Click outside to close context menu and settings menu
            document.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    closeContextMenu();
                }

                if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                    settingsMenu.classList.remove('active');
                }

                if (e.target === canvasArea || e.target === connectionsLayer) {
                    if (!appState.selectionBox.isSelecting) {
                        deselectAllPages();
                    }
                }
                
                // Close mobile sidebar when clicking on canvas
                if (appState.isMobile && (e.target === canvasArea || e.target.closest('.main-canvas'))) {
                    closeMobileSidebar();
                }
                
                // Close icon picker when clicking outside (FIXED)
                if (iconPickerModal.classList.contains('active') && 
                    !e.target.closest('.icon-picker-content') && 
                    e.target !== openIconPickerBtn) {
                    closeIconPicker();
                }
            });

            // Key shortcuts
            document.addEventListener('keydown', (e) => {
                appState.isCtrlPressed = e.ctrlKey || e.metaKey;

                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    e.preventDefault();
                    selectAllPages();
                }

                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                }

                if ((e.ctrlKey && e.key === 'y') || ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Z')) {
                    e.preventDefault();
                    redo();
                }

                if (e.key === 'Delete' && appState.selectedPageIds.length > 0) {
                    e.preventDefault();
                    showMassDeleteModal();
                }

                if (e.key === 'Escape') {
                    deselectAllPages();
                    closeContextMenu();
                    closeMobileSidebar();
                    closeIconPicker();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'Control' || e.key === 'Meta') {
                    appState.isCtrlPressed = false;
                }
            });

            // Window resize handler
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', handleResize);
        }

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================

        function toggleGrid() {
            appState.settings.showGrid = toggleGridCheckbox.checked;
            if (appState.settings.showGrid) {
                canvasArea.style.backgroundImage =
                    `linear-gradient(90deg, var(--border-color) 1px, transparent 1px),
                     linear-gradient(var(--border-color) 1px, transparent 1px)`;
            } else {
                canvasArea.style.backgroundImage = 'none';
            }
        }

        function toggleMultiSelectMode() {
            appState.settings.multiSelectMode = multiSelectModeCheckbox.checked;
            showNotification(
                appState.settings.multiSelectMode ?
                    'Multi-select enabled (Ctrl+Click to select multiple)' :
                    'Single-select mode enabled',
                'info'
            );
        }

        // ============================================
        // SAMPLE DATA CREATION
        // ============================================

        function createSampleStructure() {
            appState.pages = {};
            appState.nextId = 1;
            appState.selectedPageIds = [];
            appState.isEditing = false;

            const homePage = createPage('Home', {
                icon: 'fas fa-home',
                type: 'static',
                slug: '',
                description: 'Home page of the website',
                position: { x: 400, y: 100 }
            });

            const aboutPage = createPage('About', {
                icon: 'fas fa-info-circle',
                type: 'static',
                parentId: homePage.id,
                description: 'About us page',
                position: { x: 200, y: 250 }
            });

            const blogPage = createPage('Blog', {
                icon: 'fas fa-blog',
                type: 'static',
                parentId: homePage.id,
                description: 'Blog listing page',
                position: { x: 400, y: 250 }
            });

            const contactPage = createPage('Contact', {
                icon: 'fas fa-envelope',
                type: 'static',
                parentId: homePage.id,
                description: 'Contact us page',
                position: { x: 600, y: 250 }
            });

            const postPage = createPage('Post', {
                icon: 'fas fa-newspaper',
                type: 'dynamic',
                slug: 'post/[id]',
                parentId: blogPage.id,
                description: 'Individual blog post',
                position: { x: 400, y: 400 }
            });

            const dashboardPage = createPage('Dashboard', {
                icon: 'fas fa-tachometer-alt',
                type: 'auth',
                slug: 'dashboard',
                parentId: homePage.id,
                description: 'User dashboard',
                protected: true,
                position: { x: 800, y: 100 }
            });

            const settingsPage = createPage('Settings', {
                icon: 'fas fa-cog',
                type: 'auth',
                parentId: dashboardPage.id,
                description: 'User settings',
                protected: true,
                position: { x: 800, y: 250 }
            });

            const apiPage = createPage('API', {
                icon: 'fas fa-server',
                type: 'api',
                slug: 'api',
                parentId: homePage.id,
                description: 'API endpoints',
                position: { x: 100, y: 100 }
            });

            const usersApiPage = createPage('Users', {
                icon: 'fas fa-users',
                type: 'api',
                slug: 'users',
                parentId: apiPage.id,
                description: 'User management API',
                position: { x: 50, y: 250 }
            });

            appState.rootId = homePage.id;

            saveToHistory();
            renderAll();

            showNotification('Sample project created', 'success');
            
            // Close sidebar on mobile after creating sample
            if (appState.isMobile) {
                closeMobileSidebar();
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================

        function convertToJSONStructure() {
            function buildTree(pageId) {
                const page = appState.pages[pageId];
                if (!page) return {};

                const node = {
                    type: page.type,
                    protected: page.protected,
                    description: page.description,
                    slug: page.slug || page.name.toLowerCase(),
                    icon: page.icon,
                    metadata: page.metadata
                };

                if (page.childrenIds.length > 0) {
                    node.children = {};
                    page.childrenIds.forEach(childId => {
                        const childPage = appState.pages[childId];
                        node.children[childPage.slug || childPage.name.toLowerCase()] = buildTree(childId);
                    });
                }

                return node;
            }

            if (appState.rootId) {
                const rootPage = appState.pages[appState.rootId];
                return {
                    [rootPage.slug || rootPage.name.toLowerCase()]: buildTree(appState.rootId)
                };
            }

            return {};
        }

        function generateSitemap() {
            function buildSitemapLines(pageId, indent = '') {
                const page = appState.pages[pageId];
                if (!page) return '';

                const path = getPagePath(pageId);
                let line = `${indent}/${path}`;

                if (page.type !== 'static') line += ` [${page.type}]`;
                if (page.protected) line += ' ðŸ”’';
                if (page.icon) line += ` ${page.icon}`;
                if (page.description) line += ` - ${page.description}`;

                line += '\n';

                page.childrenIds.forEach(childId => {
                    line += buildSitemapLines(childId, indent + '  ');
                });

                return line;
            }

            if (appState.rootId) {
                return buildSitemapLines(appState.rootId);
            }

            return 'No pages in sitemap';
        }

        function generateReactRoutes() {
            function buildReactRoutes(pageId, indent = '') {
                const page = appState.pages[pageId];
                if (!page) return '';

                const path = getPagePath(pageId);
                const elementName = page.name.replace(/[^a-zA-Z0-9]/g, '');
                let code = '';

                if (page.id === appState.rootId) {
                    code += `${indent}<Routes>\n`;
                    code += `${indent}  <Route path="/" element={<Home />}>\n`;
                } else {
                    code += `${indent}<Route path="${path.replace(/^[^\/]+\//, '')}" element={<${elementName} />}`;

                    if (page.childrenIds.length > 0) {
                        code += '>\n';
                    } else {
                        code += ' />\n';
                    }
                }

                page.childrenIds.forEach(childId => {
                    code += buildReactRoutes(childId, indent + '  ');
                });

                if (page.childrenIds.length > 0) {
                    code += `${indent}</Route>\n`;
                }

                if (page.id === appState.rootId) {
                    code += `${indent}</Routes>\n`;
                }

                return code;
            }

            if (appState.rootId) {
                let code = 'import { Routes, Route } from "react-router-dom";\n\n';
                code += 'function AppRoutes() {\n';
                code += '  return (\n';
                code += buildReactRoutes(appState.rootId, '    ');
                code += '  );\n';
                code += '}\n';
                code += '\nexport default AppRoutes;';
                return code;
            }

            return '// No routes to generate';
        }

        function generateNextJSRoutes() {
            function buildNextJSRoutes(pageId, basePath = '') {
                const page = appState.pages[pageId];
                if (!page) return '';

                const path = getPagePath(pageId);
                let code = '';

                if (page.type === 'dynamic') {
                    code += `[${page.slug || page.name.toLowerCase()}]/\n`;
                } else {
                    code += `${page.slug || page.name.toLowerCase()}/\n`;
                }

                code += `  page.tsx\n`;

                if (page.childrenIds.length > 0) {
                    code += `  layout.tsx\n`;
                }

                page.childrenIds.forEach(childId => {
                    const childIndent = '  ';
                    const childCode = buildNextJSRoutes(childId, path);
                    code += childCode.split('\n').map(line => childIndent + line).join('\n');
                });

                return code;
            }

            if (appState.rootId) {
                let code = 'app/\n';
                code += buildNextJSRoutes(appState.rootId);
                return code;
            }

            return '// No routes to generate';
        }

        function showExportModal(title, content) {
            exportImportModalTitle.textContent = title;
            exportContent.textContent = content;
            exportContentSection.style.display = 'block';
            exportImportModal.classList.add('active');
            
            // Close sidebar on mobile when opening export modal
            if (appState.isMobile) {
                closeMobileSidebar();
            }
        }

        // ============================================
        // IMPORT FUNCTIONS
        // ============================================

        function importProject(jsonString) {
            try {
                const data = JSON.parse(jsonString);

                if (!data.pages || !data.rootId || data.nextId === undefined) {
                    throw new Error('Invalid project format');
                }

                appState.pages = data.pages;
                appState.rootId = data.rootId;
                appState.nextId = data.nextId;
                appState.selectedPageIds = [];
                appState.isEditing = false;

                saveToHistory();
                renderAll();

                showNotification('Project imported successfully', 'success');
            } catch (error) {
                console.error('Import error:', error);
                showNotification('Failed to import project: ' + error.message, 'error');
            }
        }

        function importFile(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                importProject(e.target.result);
                appState.projectName = file.name.replace('.json', '');
            };
            reader.readAsText(file);
        }

        function importFromClipboard() {
            navigator.clipboard.readText().then(text => {
                importProject(text);
            }).catch(err => {
                showNotification('Failed to read from clipboard', 'error');
            });
        }

        function handleResize() {
            appState.isMobile = window.innerWidth <= 900;
            
            if (!appState.isMobile) {
                // On desktop, ensure sidebar is visible
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                mobileSidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
                appState.sidebarVisible = true;
            } else {
                // On mobile, hide sidebar by default
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                appState.sidebarVisible = false;
            }
            
            setTimeout(() => {
                renderPageNodes();
            }, 100);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            initTheme();
            setupEventListeners();
            updateUndoRedoButtons();
            
            // Initialize icon picker
            populateIconGrid('all');
            
            // Check if mobile on init
            handleResize();

            const savedProject = localStorage.getItem('routemap-pro-project');
            if (savedProject) {
                try {
                    const data = JSON.parse(savedProject);
                    if (data.pages && data.rootId) {
                        appState.pages = data.pages;
                        appState.rootId = data.rootId;
                        appState.nextId = data.nextId || Object.keys(data.pages).length + 1;
                        appState.projectName = data.projectName || 'Untitled Project';

                        saveToHistory();
                        renderAll();

                        showNotification('Project loaded from local storage', 'info');
                        return;
                    }
                } catch (error) {
                    console.error('Error loading saved project:', error);
                }
            }

            createSampleStructure();
        }

        // Auto-save to localStorage
        setInterval(() => {
            const projectData = {
                pages: appState.pages,
                rootId: appState.rootId,
                nextId: appState.nextId,
                projectName: appState.projectName,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('routemap-pro-project', JSON.stringify(projectData));
        }, 30000);

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>

</html>